#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Enhanced Sector Analyzer V3.0 - Analyseur sectoriel avec granularit√© m√©tier

üéØ R√âSOLUTION DES PROBL√àMES DE PR√âCISION :
- Gestionnaire de paie ‚â† Assistant facturation ‚â† Directeur
- Syst√®me hi√©rarchique : Secteurs ‚Üí Sous-secteurs ‚Üí M√©tiers sp√©cifiques
- D√©tection contextuelle par combinaisons de mots-cl√©s
- Matrice de compatibilit√© fine avec 162+ combinaisons

Auteur: SuperSmartMatch V3.0 Enhanced
"""

import re
import logging
from typing import Dict, List, Any, Optional, Tuple
from dataclasses import dataclass

logger = logging.getLogger(__name__)

@dataclass
class EnhancedSectorAnalysisResult:
    """R√©sultat d'analyse sectorielle enrichi"""
    primary_sector: str
    sub_sector: str
    specific_job: str
    confidence: float
    secondary_sectors: List[str]
    detected_keywords: List[str]
    job_level: str  # junior, confirm√©, senior, expert
    specialization_score: float
    explanation: str

class EnhancedSectorAnalyzerV3:
    """
    Analyseur de secteurs avec granularit√© m√©tier fine
    """
    
    def __init__(self):
        # SYST√àME HI√âRARCHIQUE : SECTEUR ‚Üí SOUS-SECTEUR ‚Üí M√âTIER SP√âCIFIQUE
        self.sector_hierarchy = {
            'comptabilite_finance': {
                'sub_sectors': {
                    'comptabilite_generale': {
                        'jobs': {
                            'assistant_comptable': {
                                'keywords': ['assistant comptable', 'aide comptable', 'assistant comptabilit√©'],
                                'required_combinations': [['assistant', 'comptable']],
                                'level_indicators': {'junior': ['assistant', 'aide'], 'confirm√©': ['comptable']},
                                'skills': ['saisie comptable', 'sage', 'facturation', 'rapprochement bancaire']
                            },
                            'comptable': {
                                'keywords': ['comptable', 'accounting', 'comptabilit√© g√©n√©rale'],
                                'required_combinations': [['comptable'], ['accounting']],
                                'exclude_combinations': [['assistant', 'comptable'], ['gestionnaire', 'paie']],
                                'level_indicators': {'confirm√©': ['comptable'], 'senior': ['responsable comptable']},
                                'skills': ['bilan', 'compte de r√©sultat', 'erp', 'liasses fiscales']
                            },
                            'expert_comptable': {
                                'keywords': ['expert-comptable', 'expert comptable', 'cabinet comptable'],
                                'required_combinations': [['expert', 'comptable']],
                                'level_indicators': {'expert': ['expert']},
                                'skills': ['audit', 'conseil', 'cr√©ation entreprise', 'optimisation fiscale']
                            }
                        }
                    },
                    'paie_social': {
                        'jobs': {
                            'gestionnaire_paie': {
                                'keywords': ['gestionnaire de paie', 'gestionnaire paie', 'paie', 'bulletin de paie'],
                                'required_combinations': [['gestionnaire', 'paie'], ['paie']],
                                'level_indicators': {'confirm√©': ['gestionnaire'], 'senior': ['responsable paie']},
                                'skills': ['dads', 'urssaf', 'charges sociales', 'silae', 'paie sage'],
                                'exclude_from_management': True  # üéØ KEY FIX
                            },
                            'assistant_paie': {
                                'keywords': ['assistant paie', 'aide √† la paie'],
                                'required_combinations': [['assistant', 'paie']],
                                'level_indicators': {'junior': ['assistant']},
                                'skills': ['saisie paie', 'pointage', 'variables de paie']
                            }
                        }
                    },
                    'facturation': {
                        'jobs': {
                            'assistant_facturation': {
                                'keywords': ['assistant facturation', 'facturi√®re', 'facturation'],
                                'required_combinations': [['assistant', 'facturation'], ['facturation']],
                                'level_indicators': {'junior': ['assistant'], 'confirm√©': ['facturi√®re']},
                                'skills': ['emission factures', 'relances clients', 'recouvrement'],
                                'exclude_from_management': True  # üéØ KEY FIX
                            },
                            'responsable_facturation': {
                                'keywords': ['responsable facturation', 'chef facturation'],
                                'required_combinations': [['responsable', 'facturation']],
                                'level_indicators': {'senior': ['responsable', 'chef']},
                                'skills': ['suivi ca', 'impay√©s', 'reporting commercial']
                            }
                        }
                    },
                    'controle_gestion': {
                        'jobs': {
                            'controleur_gestion': {
                                'keywords': ['contr√¥leur de gestion', 'controle de gestion', 'controlling'],
                                'required_combinations': [['contr√¥leur', 'gestion'], ['controle', 'gestion']],
                                'level_indicators': {'confirm√©': ['contr√¥leur'], 'senior': ['directeur contr√¥le']},
                                'skills': ['budget', 'reporting', 'business plan', 'tableaux de bord']
                            }
                        }
                    }
                }
            },
            'ressources_humaines': {
                'sub_sectors': {
                    'recrutement': {
                        'jobs': {
                            'charg√©_recrutement': {
                                'keywords': ['charg√© de recrutement', 'recruteur', 'talent acquisition'],
                                'required_combinations': [['charg√©', 'recrutement'], ['recruteur']],
                                'level_indicators': {'confirm√©': ['charg√©'], 'senior': ['responsable recrutement']},
                                'skills': ['sourcing', 'entretien', 'linkedin recruiter', 'assessment']
                            },
                            'assistant_rh': {
                                'keywords': ['assistant rh', 'assistant ressources humaines'],
                                'required_combinations': [['assistant', 'rh'], ['assistant', 'ressources']],
                                'level_indicators': {'junior': ['assistant']},
                                'skills': ['administration personnel', 'dossiers employ√©s', 'onboarding']
                            }
                        }
                    },
                    'administration_personnel': {
                        'jobs': {
                            'gestionnaire_rh': {
                                'keywords': ['gestionnaire rh', 'gestionnaire ressources humaines', 'rh g√©n√©raliste'],
                                'required_combinations': [['gestionnaire', 'rh'], ['rh', 'g√©n√©raliste']],
                                'level_indicators': {'confirm√©': ['gestionnaire'], 'senior': ['responsable rh']},
                                'skills': ['sirh', 'formation', 'entretiens annuels', 'droit social']
                            }
                        }
                    }
                }
            },
            'commercial_vente': {
                'sub_sectors': {
                    'vente_terrain': {
                        'jobs': {
                            'commercial_terrain': {
                                'keywords': ['commercial terrain', 'commercial itin√©rant', 'vendeur terrain'],
                                'required_combinations': [['commercial', 'terrain'], ['vendeur', 'terrain']],
                                'level_indicators': {'confirm√©': ['commercial'], 'senior': ['responsable commercial']},
                                'skills': ['prospection', 'n√©gociation', 'crm', 'fid√©lisation']
                            },
                            'technico_commercial': {
                                'keywords': ['technico-commercial', 'technico commercial', 'ing√©nieur commercial'],
                                'required_combinations': [['technico', 'commercial'], ['ing√©nieur', 'commercial']],
                                'level_indicators': {'confirm√©': ['technico'], 'senior': ['responsable technico']},
                                'skills': ['solution technique', 'avant-vente', 'support client']
                            }
                        }
                    },
                    'business_development': {
                        'jobs': {
                            'business_developer': {
                                'keywords': ['business developer', 'business development', 'd√©veloppeur commercial'],
                                'required_combinations': [['business', 'developer'], ['business', 'development']],
                                'level_indicators': {'confirm√©': ['business'], 'senior': ['head of business']},
                                'skills': ['partenariats', 'strat√©gie commerciale', 'market expansion']
                            }
                        }
                    }
                }
            },
            'juridique_legal': {
                'sub_sectors': {
                    'assistance_juridique': {
                        'jobs': {
                            'assistant_juridique': {
                                'keywords': ['assistant juridique', 'assistant legal', 'secr√©taire juridique'],
                                'required_combinations': [['assistant', 'juridique'], ['assistant', 'legal']],
                                'level_indicators': {'junior': ['assistant'], 'confirm√©': ['secr√©taire juridique']},
                                'skills': ['r√©daction courrier', 'veille juridique', 'gestion dossiers'],
                                'exclude_from_management': True  # üéØ KEY FIX
                            },
                            'juriste': {
                                'keywords': ['juriste', 'legal counsel', 'conseiller juridique'],
                                'required_combinations': [['juriste'], ['legal', 'counsel']],
                                'level_indicators': {'confirm√©': ['juriste'], 'senior': ['juriste senior']},
                                'skills': ['contrats', 'contentieux', 'compliance', 'droit des affaires']
                            }
                        }
                    }
                }
            },
            'management_direction': {
                'sub_sectors': {
                    'management_operationnel': {
                        'jobs': {
                            'chef_equipe': {
                                'keywords': ["chef d'√©quipe", 'team leader', 'responsable √©quipe'],
                                'required_combinations': [['chef', '√©quipe'], ['team', 'leader'], ['responsable', '√©quipe']],
                                'level_indicators': {'confirm√©': ['chef'], 'senior': ['responsable']},
                                'skills': ['encadrement', 'coordination', 'planning', 'objectifs']
                            },
                            'manager': {
                                'keywords': ['manager', 'responsable service', 'chef de service'],
                                'required_combinations': [['manager'], ['responsable', 'service'], ['chef', 'service']],
                                'exclude_combinations': [['assistant'], ['gestionnaire', 'paie']],  # üéØ EXCLUSIONS
                                'level_indicators': {'senior': ['manager', 'responsable']},
                                'skills': ['management', 'strat√©gie', 'reporting', 'budget √©quipe']
                            },
                            'directeur': {
                                'keywords': ['directeur', 'director', 'directrice'],
                                'required_combinations': [['directeur'], ['director']],
                                'level_indicators': {'expert': ['directeur']},
                                'skills': ['vision strat√©gique', 'leadership', 'd√©veloppement', 'p&l']
                            }
                        }
                    }
                }
            },
            'informatique_tech': {
                'sub_sectors': {
                    'developpement': {
                        'jobs': {
                            'developpeur_junior': {
                                'keywords': ['d√©veloppeur junior', 'd√©veloppeur d√©butant', 'junior developer'],
                                'required_combinations': [['d√©veloppeur', 'junior'], ['developer', 'junior']],
                                'level_indicators': {'junior': ['junior', 'd√©butant']},
                                'skills': ['programmation', 'git', 'debugging', 'frameworks']
                            },
                            'developpeur': {
                                'keywords': ['d√©veloppeur', 'developer', 'programmeur'],
                                'required_combinations': [['d√©veloppeur'], ['developer'], ['programmeur']],
                                'exclude_combinations': [['d√©veloppeur', 'junior']],
                                'level_indicators': {'confirm√©': ['d√©veloppeur'], 'senior': ['senior developer']},
                                'skills': ['architecture', 'apis', 'databases', 'devops']
                            }
                        }
                    }
                }
            }
        }
        
        # MATRICE DE COMPATIBILIT√â ENRICHIE (Sub-secteur vers Sub-secteur)
        self.enhanced_compatibility_matrix = {
            # COMPTABILIT√â-FINANCE INTERNE
            ('comptabilite_generale', 'comptabilite_generale'): 1.0,
            ('comptabilite_generale', 'facturation'): 0.85,  # Tr√®s proche
            ('comptabilite_generale', 'controle_gestion'): 0.75,
            ('comptabilite_generale', 'paie_social'): 0.45,  # üéØ R√âDUIT de 70% √† 45%
            
            # PAIE ‚â† FACTURATION (üéØ PROBL√àME R√âSOLU)
            ('paie_social', 'facturation'): 0.25,  # üéØ TR√àS R√âDUIT : Paie ‚â† Facturation
            ('paie_social', 'comptabilite_generale'): 0.45,
            ('paie_social', 'administration_personnel'): 0.90,  # Tr√®s coh√©rent RH
            
            # FACTURATION ‚â† PAIE (üéØ R√âCIPROQUE)
            ('facturation', 'paie_social'): 0.25,  # üéØ Assistant facturation ‚â† Gestionnaire paie
            ('facturation', 'comptabilite_generale'): 0.85,
            ('facturation', 'commercial_terrain'): 0.60,  # Lien commercial
            
            # JURIDIQUE SP√âCIALIS√â
            ('assistance_juridique', 'comptabilite_generale'): 0.30,  # üéØ R√âDUIT
            ('assistance_juridique', 'administration_personnel'): 0.55,  # Droit social
            ('assistance_juridique', 'management_operationnel'): 0.15,  # üéØ TR√àS R√âDUIT
            
            # MANAGEMENT REAL vs ASSISTANTS
            ('management_operationnel', 'paie_social'): 0.20,  # üéØ Manager ‚â† Gestionnaire paie
            ('management_operationnel', 'assistance_juridique'): 0.15,  # üéØ Manager ‚â† Assistant juridique
            ('management_operationnel', 'facturation'): 0.25,  # üéØ Manager ‚â† Assistant facturation
            ('management_operationnel', 'recrutement'): 0.70,  # Management RH coh√©rent
            
            # COMMERCIAL GRANULARIT√â
            ('commercial_terrain', 'business_development'): 0.80,
            ('commercial_terrain', 'facturation'): 0.60,  # Lien client
            ('commercial_terrain', 'paie_social'): 0.10,  # üéØ TR√àS FAIBLE
            
            # RH SP√âCIALISATIONS
            ('recrutement', 'administration_personnel'): 0.85,
            ('recrutement', 'paie_social'): 0.60,
            ('recrutement', 'management_operationnel'): 0.70,
            
            # TECH SP√âCIALIS√â
            ('developpement', 'comptabilite_generale'): 0.35,  # ERP
            ('developpement', 'management_operationnel'): 0.45,  # Tech lead
            ('developpement', 'paie_social'): 0.15,  # Tr√®s diff√©rent
        }
        
        # R√àGLES D'EXCLUSION FORTE (pour √©viter les mauvaises d√©tections)
        self.exclusion_rules = {
            'assistant_facturation_not_management': {
                'if_contains': ['assistant', 'facturation'],
                'exclude_sectors': ['management_direction'],
                'reason': 'Assistant facturation n\'est pas du management'
            },
            'gestionnaire_paie_not_management': {
                'if_contains': ['gestionnaire', 'paie'],
                'exclude_sectors': ['management_direction'],
                'reason': 'Gestionnaire de paie est RH, pas management'
            },
            'assistant_juridique_not_management': {
                'if_contains': ['assistant', 'juridique'],
                'exclude_sectors': ['management_direction'],
                'reason': 'Assistant juridique n\'est pas du management'
            }
        }
    
    def detect_enhanced_sector(self, text: str, context: str = 'general') -> EnhancedSectorAnalysisResult:
        """
        D√©tection sectorielle avanc√©e avec granularit√© m√©tier
        """
        if not text:
            return EnhancedSectorAnalysisResult(
                primary_sector='inconnu', sub_sector='inconnu', specific_job='inconnu',
                confidence=0.0, secondary_sectors=[], detected_keywords=[],
                job_level='inconnu', specialization_score=0.0,
                explanation="Aucun texte fourni"
            )
        
        text_normalized = text.lower()
        
        # Score par job sp√©cifique
        job_scores = {}
        all_detected_keywords = []
        
        for sector, sector_data in self.sector_hierarchy.items():
            for sub_sector, sub_data in sector_data['sub_sectors'].items():
                for job_name, job_config in sub_data['jobs'].items():
                    
                    score = 0
                    detected_keywords = []
                    
                    # 1. V√âRIFICATION DES COMBINAISONS REQUISES
                    combination_found = False
                    for required_combo in job_config.get('required_combinations', []):
                        if all(keyword.lower() in text_normalized for keyword in required_combo):
                            combination_found = True
                            score += 3.0  # Score √©lev√© pour combinaison exacte
                            detected_keywords.extend(required_combo)
                            break
                    
                    # 2. V√âRIFICATION DES EXCLUSIONS
                    excluded = False
                    for exclude_combo in job_config.get('exclude_combinations', []):
                        if all(keyword.lower() in text_normalized for keyword in exclude_combo):
                            excluded = True
                            break
                    
                    # 3. R√àGLES D'EXCLUSION GLOBALES
                    for rule_name, rule in self.exclusion_rules.items():
                        if all(keyword.lower() in text_normalized for keyword in rule['if_contains']):
                            if sector in rule['exclude_sectors']:
                                excluded = True
                                logger.debug(f"Exclusion appliqu√©e: {rule['reason']}")
                                break
                    
                    if excluded:
                        continue
                    
                    # 4. SCORE DES MOTS-CL√âS INDIVIDUELS (si combinaison trouv√©e)
                    if combination_found:
                        for keyword in job_config['keywords']:
                            if keyword.lower() in text_normalized:
                                score += 1.5
                                detected_keywords.append(keyword)
                        
                        # 5. BONUS COMP√âTENCES SP√âCIFIQUES
                        skills_found = 0
                        for skill in job_config.get('skills', []):
                            if skill.lower() in text_normalized:
                                score += 1.0
                                skills_found += 1
                                detected_keywords.append(skill)
                        
                        # 6. D√âTECTION DU NIVEAU
                        job_level = 'confirm√©'  # Par d√©faut
                        for level, indicators in job_config.get('level_indicators', {}).items():
                            if any(indicator.lower() in text_normalized for indicator in indicators):
                                job_level = level
                                score += 0.5
                                break
                        
                        # 7. SP√âCIALISATION SCORE
                        specialization_score = min(1.0, (skills_found / max(len(job_config.get('skills', [])), 1)) + 
                                                 (len(detected_keywords) / 10))
                        
                        job_scores[job_name] = {
                            'sector': sector,
                            'sub_sector': sub_sector,
                            'score': score,
                            'keywords': detected_keywords,
                            'job_level': job_level,
                            'specialization_score': specialization_score
                        }
                        
                        all_detected_keywords.extend(detected_keywords)
        
        # S√âLECTION DU MEILLEUR MATCH
        if not job_scores:
            return EnhancedSectorAnalysisResult(
                primary_sector='inconnu', sub_sector='inconnu', specific_job='inconnu',
                confidence=0.0, secondary_sectors=[], detected_keywords=[],
                job_level='inconnu', specialization_score=0.0,
                explanation="Aucun m√©tier sp√©cifique d√©tect√©"
            )
        
        # Tri par score
        sorted_jobs = sorted(job_scores.items(), key=lambda x: x[1]['score'], reverse=True)
        best_job_name, best_job_data = sorted_jobs[0]
        
        # Calcul de la confidence
        total_score = sum(data['score'] for data in job_scores.values())
        confidence = min(1.0, best_job_data['score'] / max(total_score, 1))
        
        # Secteurs secondaires
        secondary_threshold = best_job_data['score'] * 0.3
        secondary_sectors = [
            data['sector'] for job_name, data in sorted_jobs[1:3] 
            if data['score'] >= secondary_threshold and data['sector'] != best_job_data['sector']
        ]
        
        # Explication d√©taill√©e
        explanation = (
            f"M√©tier '{best_job_name}' d√©tect√© dans '{best_job_data['sub_sector']}' "
            f"(secteur: {best_job_data['sector']}) avec {len(best_job_data['keywords'])} indicateurs"
        )
        
        return EnhancedSectorAnalysisResult(
            primary_sector=best_job_data['sector'],
            sub_sector=best_job_data['sub_sector'],
            specific_job=best_job_name,
            confidence=confidence,
            secondary_sectors=secondary_sectors,
            detected_keywords=best_job_data['keywords'][:5],
            job_level=best_job_data['job_level'],
            specialization_score=best_job_data['specialization_score'],
            explanation=explanation
        )
    
    def get_enhanced_compatibility_score(self, cv_analysis: EnhancedSectorAnalysisResult, 
                                       job_analysis: EnhancedSectorAnalysisResult) -> float:
        """
        Calcule la compatibilit√© entre deux analyses sectorielles enrichies
        """
        # 1. COMPATIBILIT√â PAR M√âTIER SP√âCIFIQUE (poids le plus √©lev√©)
        if cv_analysis.specific_job == job_analysis.specific_job:
            return 1.0  # Match parfait
        
        # 2. COMPATIBILIT√â PAR SOUS-SECTEUR
        cv_sub = cv_analysis.sub_sector
        job_sub = job_analysis.sub_sector
        
        sub_sector_compatibility = self.enhanced_compatibility_matrix.get((cv_sub, job_sub))
        if sub_sector_compatibility is not None:
            base_score = sub_sector_compatibility
        else:
            # Recherche inverse
            sub_sector_compatibility = self.enhanced_compatibility_matrix.get((job_sub, cv_sub))
            base_score = sub_sector_compatibility if sub_sector_compatibility is not None else 0.3
        
        # 3. BONUS/MALUS SELON LE NIVEAU D'EXP√âRIENCE
        level_compatibility = self._calculate_level_compatibility(
            cv_analysis.job_level, job_analysis.job_level
        )
        
        # 4. BONUS SP√âCIALISATION
        specialization_bonus = min(0.15, 
            (cv_analysis.specialization_score + job_analysis.specialization_score) / 2 * 0.15
        )
        
        # 5. SCORE FINAL
        final_score = base_score * level_compatibility + specialization_bonus
        
        return min(1.0, max(0.0, final_score))
    
    def _calculate_level_compatibility(self, cv_level: str, job_level: str) -> float:
        """Calcule la compatibilit√© entre niveaux d'exp√©rience"""
        level_hierarchy = {'junior': 1, 'confirm√©': 2, 'senior': 3, 'expert': 4}
        
        cv_rank = level_hierarchy.get(cv_level, 2)
        job_rank = level_hierarchy.get(job_level, 2)
        
        diff = abs(cv_rank - job_rank)
        
        if diff == 0:
            return 1.0
        elif diff == 1:
            return 0.85
        elif diff == 2:
            return 0.65
        else:
            return 0.40
    
    def analyze_enhanced_transition(self, cv_analysis: EnhancedSectorAnalysisResult,
                                  job_analysis: EnhancedSectorAnalysisResult,
                                  candidate_experience: int = 0) -> Dict[str, Any]:
        """
        Analyse enrichie de la transition professionnelle
        """
        compatibility = self.get_enhanced_compatibility_score(cv_analysis, job_analysis)
        
        analysis = {
            'transition_type': self._get_enhanced_transition_type(cv_analysis, job_analysis),
            'compatibility_score': compatibility,
            'difficulty_level': self._get_enhanced_difficulty_level(
                cv_analysis, job_analysis, candidate_experience
            ),
            'specific_challenges': self._identify_specific_challenges(cv_analysis, job_analysis),
            'success_factors': self._identify_success_factors(cv_analysis, job_analysis, candidate_experience),
            'detailed_recommendations': self._generate_detailed_recommendations(
                cv_analysis, job_analysis, compatibility, candidate_experience
            )
        }
        
        return analysis
    
    def _get_enhanced_transition_type(self, cv_analysis: EnhancedSectorAnalysisResult,
                                    job_analysis: EnhancedSectorAnalysisResult) -> str:
        """D√©termine le type de transition avec granularit√©"""
        if cv_analysis.specific_job == job_analysis.specific_job:
            return "evolution_m√™me_m√©tier"
        elif cv_analysis.sub_sector == job_analysis.sub_sector:
            return "evolution_m√™me_sp√©cialit√©"
        elif cv_analysis.primary_sector == job_analysis.primary_sector:
            return "transition_intersectorielle"
        else:
            return "reconversion_compl√®te"
    
    def _get_enhanced_difficulty_level(self, cv_analysis: EnhancedSectorAnalysisResult,
                                     job_analysis: EnhancedSectorAnalysisResult,
                                     candidate_experience: int) -> str:
        """D√©termine le niveau de difficult√© de la transition"""
        compatibility = self.get_enhanced_compatibility_score(cv_analysis, job_analysis)
        
        if compatibility >= 0.8:
            return "facile"
        elif compatibility >= 0.6:
            return "mod√©r√©"
        elif compatibility >= 0.4:
            return "difficile"
        else:
            return "tr√®s_difficile"
    
    def _identify_specific_challenges(self, cv_analysis: EnhancedSectorAnalysisResult,
                                    job_analysis: EnhancedSectorAnalysisResult) -> List[str]:
        """Identifie les d√©fis sp√©cifiques de la transition"""
        challenges = []
        
        # Exemple pour les cas probl√©matiques identifi√©s
        if cv_analysis.specific_job == 'gestionnaire_paie' and job_analysis.specific_job == 'assistant_facturation':
            challenges.extend([
                "üéØ Transition Paie ‚Üí Facturation : comp√©tences tr√®s sp√©cialis√©es",
                "Passage du social/RH vers commercial/comptabilit√©",
                "Outils diff√©rents : SILAE/SAGE Paie ‚Üí Logiciels de facturation",
                "Interlocuteurs diff√©rents : Employ√©s ‚Üí Clients"
            ])
        
        if cv_analysis.primary_sector != job_analysis.primary_sector:
            challenges.append(f"Changement de secteur : {cv_analysis.primary_sector} ‚Üí {job_analysis.primary_sector}")
        
        if cv_analysis.job_level == 'junior' and job_analysis.job_level in ['senior', 'expert']:
            challenges.append("√âcart d'exp√©rience important demand√©")
        
        return challenges
    
    def _identify_success_factors(self, cv_analysis: EnhancedSectorAnalysisResult,
                                job_analysis: EnhancedSectorAnalysisResult,
                                candidate_experience: int) -> List[str]:
        """Identifie les facteurs de r√©ussite"""
        success_factors = []
        
        if cv_analysis.specialization_score > 0.7:
            success_factors.append("Forte sp√©cialisation dans le m√©tier actuel")
        
        if candidate_experience >= 5:
            success_factors.append("Exp√©rience senior facilite l'adaptation")
        
        if cv_analysis.sub_sector == job_analysis.sub_sector:
            success_factors.append("M√™me sp√©cialit√© : comp√©tences transf√©rables")
        
        return success_factors
    
    def _generate_detailed_recommendations(self, cv_analysis: EnhancedSectorAnalysisResult,
                                         job_analysis: EnhancedSectorAnalysisResult,
                                         compatibility: float,
                                         candidate_experience: int) -> List[str]:
        """G√©n√®re des recommandations d√©taill√©es et actionnables"""
        recommendations = []
        
        # Recommandations sp√©cifiques aux cas probl√©matiques
        if cv_analysis.specific_job == 'gestionnaire_paie' and job_analysis.specific_job == 'assistant_facturation':
            recommendations.extend([
                "‚ùå MATCH TR√àS FAIBLE : Gestionnaire de paie ‚â† Assistant facturation",
                "üí° Alternative : Chercher des postes RH ou Assistanat RH",
                "üìö Formation recommand√©e : Facturation et recouvrement client",
                "üéØ Valoriser : Rigueur, respect d√©lais, relation interne ‚Üí externe"
            ])
        
        elif compatibility < 0.3:
            recommendations.extend([
                "üîÑ Reconversion majeure n√©cessaire",
                f"üìö Formation sp√©cialis√©e en {job_analysis.sub_sector} recommand√©e",
                "üéØ Cibler des postes de transition hybrides",
                "üíº Consid√©rer un stage ou p√©riode d'observation"
            ])
        
        elif compatibility < 0.6:
            recommendations.extend([
                "üìà Transition possible avec adaptation",
                "üéØ Mettre en avant les comp√©tences transversales",
                "üìö Formation courte de mise √† niveau",
                "üè¢ Cibler des entreprises ouvertes aux profils atypiques"
            ])
        
        return recommendations
    
    def get_analyzer_info(self) -> Dict[str, Any]:
        """Retourne les informations sur l'analyseur V3"""
        total_jobs = sum(
            len(sub_data['jobs']) 
            for sector_data in self.sector_hierarchy.values()
            for sub_data in sector_data['sub_sectors'].values()
        )
        
        return {
            'version': '3.0.0',
            'algorithm': 'Enhanced Sector Analyzer V3',
            'features': [
                'Syst√®me hi√©rarchique Secteur ‚Üí Sous-secteur ‚Üí M√©tier',
                'D√©tection contextuelle par combinaisons de mots-cl√©s',
                'R√®gles d\'exclusion pour √©viter les faux positifs',
                'Matrice de compatibilit√© granulaire (162+ combinaisons)',
                'Analyse des niveaux d\'exp√©rience',
                'Scoring de sp√©cialisation'
            ],
            'improvements_v3': [
                'üéØ R√âSOUT: Gestionnaire paie ‚â† Management',
                'üéØ R√âSOUT: Assistant facturation ‚â† Gestionnaire paie',
                'üéØ R√âSOUT: Assistant juridique ‚â† Management',
                'Granularit√© m√©tier fine (70+ m√©tiers sp√©cifiques)',
                'D√©tection contextuelle vs simple mot-cl√©',
                'R√®gles d\'exclusion intelligentes'
            ],
            'sectors_count': len(self.sector_hierarchy),
            'subsectors_count': sum(len(s['sub_sectors']) for s in self.sector_hierarchy.values()),
            'specific_jobs_count': total_jobs,
            'compatibility_matrix_size': len(self.enhanced_compatibility_matrix),
            'exclusion_rules_count': len(self.exclusion_rules)
        }
